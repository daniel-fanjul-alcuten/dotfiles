#!/bin/bash
set -e

unset postponed
while getopts 'p' opt; do
  case $opt in
    p) postponed=true;;
    *) exit 1
  esac
done
shift $((OPTIND - 1))

id="$1" && shift || { echo id?; exit 1; }
name="$1" && shift || {
  name=$(sudo docker inspect -f '{{.Name}}' "$id")
  name=${name#/}
  name=$(sed 's,/,-,g' <<< "$name")
}

if [ -z "$postponed" ]; then
  mkdir -p ~/var/{lock,log}
  lock=docker-export-container-"$id-$name"
  nohup postpone -l ~/var/lock/lock-"$lock" "$0" -p "$id" "$name" &>> ~/var/log/"$lock".log &
  exit 0
fi
set -x

file=~/var/backups/docker/containers/"$name-$id".tar
mkdir -p "${file%/*}"
sudo docker export -o "$file" "$id" || { rm -f "$file"; false; }
sudo chown "$(whoami):$(whoami)" "$file"
