#!/bin/bash
set -x
set -e
set -o pipefail

unset options
while getopts 'sem:' opt; do
  case $opt in
    s)
      options="$options -s";;
    e)
      options="$options -e";;
    m)
      options="$options -m $OPTARG";;
    *)
      exit 1;;
  esac
done
shift $((OPTIND - 1))

origin="$1" && shift
target="$1" && shift

mkdir -p ~/var/{lock,log}
lock=backup-dir-$(md5sum <<< "$options $origin $target $*" | cut -f 1 -d ' ')
elock=backup-dir-$(md5sum <<< "$target" | cut -f 1 -d ' ')
log="$lock-$RANDOM".log
eval \
  postpone -f -l ~/var/lock/lock-"$lock" -L ~/var/lock/elock-"$elock" \
  ~/bin/mail-exec ~/var/log/"$log" \""backup $target"\" \
  ~/bin/backup-dir "$options" "$origin" "$target" "$@"
