#!/bin/bash
set -e
set -x

source ~/etc/backup.cfg

for name in "$@"; do

  mountpoint="$name"
  if ! mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -m 0775 -p "$dir"

  dir="$mountpoint"/backups
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(hostname)
  mkdir -m 0775 -p "$dir"

  sudo -H bup init
  eval sudo -H bup index -v -x $machine_excludes /

  sudo -H SSH_AUTH_SOCK="$SSH_AUTH_SOCK" bup init -r dfanjul@localhost:"$dir"/bup
  sudo -H SSH_AUTH_SOCK="$SSH_AUTH_SOCK" bup save -v -r dfanjul@localhost:"$dir"/bup -n "$(whoami)@$(hostname)" /

  s3qlctrl upload-meta "$mountpoint"

done
