#!/bin/bash
set -e
set -o pipefail

dir=$(git rev-parse --show-toplevel)
if [ -z "$dir" ]; then
  dir=$(git rev-parse --git-dir)
  dir=$(readlink -e "$dir")
fi

mkdir -p ~/var/{lock,log}

now="$(date +%s)"
if [ "$(git config gc.lastfsck || echo 0)" -lt $((now - $((3 * 24 * 3600)))) ]; then
  lock=git-$(md5sum <<< "$dir" | cut -f 1 -d ' ')
  log="$lock-$RANDOM".log
  if postpone -f -L ~/var/lock/elock-"$lock" -L ~/var/lock/elock-git ~/bin/mail-exec ~/var/log/"$log" "git-fsck $dir" git fsck; then
    git config gc.lastfsck "$now"
  fi
fi

if [ "$(git config gc.lastgc || echo 0)" -lt $((now - $((5 * 24 * 3600)))) ]; then
  lock=git-$(md5sum <<< "$dir" | cut -f 1 -d ' ')
  log="$lock-$RANDOM".log
  if postpone -f -L ~/var/lock/elock-"$lock" -L ~/var/lock/elock-git ~/bin/mail-exec ~/var/log/"$log" "git-gc-auto $dir" git gc --auto; then
    git config gc.lastgc "$now"
  fi
fi

if [ "$(git config gc.lastgcaggressive || echo 0)" -lt $((now - $((31 * 24 * 3600)))) ]; then
  lock=git-$(md5sum <<< "$dir" | cut -f 1 -d ' ')
  log="$lock-$RANDOM".log
  if postpone -f -L ~/var/lock/elock-"$lock" -L ~/var/lock/elock-git ~/bin/mail-exec ~/var/log/"$log" "git-gc-aggressive $dir" git gc --aggressive; then
    git config gc.lastgcaggressive "$now"
  fi
fi

