#!/bin/bash
set -e
set -x

source ~/etc/backup.cfg

for name in "$@"; do

  mountpoint="$name"
  if ! mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -m 0775 -p "$dir"

  dir="$dir"/backups
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(hostname)
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(whoami)
  mkdir -m 0775 -p "$dir"

  work="$dir"/work
  mkdir -m 0775 -p "$work"
  eval ~/bin/rsync-s3ql -v --delete --delete-excluded $home_rsync_excludes --one-file-system ~/ "$work"

  file="$dir"/"$now"
  s3qlcp "$work" "$file".s3qlcp
  mv "$file".s3qlcp "$file".s3qllock
  s3qllock "$file".s3qllock
  mv "$file".s3qllock "$file"

  unset forget
  if [ "$name" = /mnt/s3ql ]; then
    forget='--minutes 120 --hours 12 --days 3'
  fi

  find "$dir" -mindepth 1 -maxdepth 1 -type d |
    ~/usr/local/bin/forget-backups $forget |
    xargs -r -t -n 1 s3qlrm

  s3qlctrl upload-meta "$mountpoint"

done
