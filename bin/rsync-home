#!/bin/bash
set -e

unset postponed
while getopts 'p' opt; do
  case $opt in
    p) postponed=true;;
    *) exit 1
  esac
done
shift $((OPTIND - 1))

if [ -z "$postponed" ]; then
  mkdir -p ~/var/{lock,log}
  for name in "$@"; do
    lock=rsync-home-$(md5sum <<< "$name" | cut -f 1 -d ' ')
    nohup postpone -l ~/var/lock/lock-"$lock" "$0" -p "$name" &>> ~/var/log/"$lock".log &
  done
  exit 0
fi
set -x

~/bin/flock-wait ~/var/lock/lock-docker-save-image-* ~/var/lock/lock-docker-export-container-*

source ~/etc/backup.cfg

for name in "$@"; do

  mountpoint="$name"
  if ! mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -m 0775 -p "$dir"

  dir="$dir"/backups
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(hostname)
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(whoami)
  mkdir -m 0775 -p "$dir"

  work="$dir"/work
  mkdir -m 0775 -p "$work"
  st=0
  eval ~/bin/rsync-s3ql -v \
    --delete --delete-excluded "$home_rsync_excludes" --one-file-system \
    ~/ "$work" && st=$? || st=$?
  [ $st -eq 0 ] || [ $st -eq 24 ] || [ $st -eq 24 ]

  file="$dir"/"$now"
  s3qlcp "$work" "$file".s3qlcp
  mv "$file".s3qlcp "$file".s3qllock
  s3qllock "$file".s3qllock
  mv "$file".s3qllock "$file"

  find "$dir" -mindepth 1 -maxdepth 1 -type d |
    ~/usr/local/bin/forget-backups --minutes 180 --hours 48 --days 5 --weeks 2 --months 1 --years 1 |
    xargs -r -t -n 1 s3qlrm

  s3qlctrl upload-meta "$mountpoint"

done
