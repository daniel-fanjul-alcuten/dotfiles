#!/bin/bash
set -e
set -x

mkdir -p ~/tmp
tmpfile=$(mktemp ~/tmp/"$(whoami)@$(hostname)"-XXXXXXXXXX.tmp)
now=$(date +%Y%m%d%H%M%S)

cd ~
git bundle create "$tmpfile" --all

for name in "$@"; do

  if [ "$name" == biabam ]; then
    git bundle list-heads "$tmpfile" |
      biabam "$tmpfile" -s "$(whoami)@$(hostname) home bundle backup" daniel.fanjul.alcuten@gmail.com
    continue
  fi

  mountpoint="/media/$name"
  if ! sudo mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -m 0775 -p "$dir"

  dir="$dir"/homes
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(hostname)
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(whoami)
  mkdir -m 0775 -p "$dir"

  file="$dir"/"$now".bundle.git
  cp "$tmpfile" "$file".tmp
  sudo s3qllock "$file".tmp
  mv "$file"{.tmp,}

  find "$dir" -type f |
    ~/usr/local/bin/forget-backups |
    xargs -r -t -n 1 sudo s3qlrm
done

rm -f "$tmpfile"
