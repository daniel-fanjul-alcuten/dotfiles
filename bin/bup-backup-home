#!/bin/bash
set -e
set -x

source ~/etc/backup.cfg

bup init
bup index $basic_excludes ~
bup save -n "$(whoami)@$(hostname)" ~
bup fsck -g

exit 0

tar cf - $basic_excludes ~ 2>/dev/null |
  pv |
  bup split -n "$now".tar 2>/dev/null

git --git-dir ~/.bup for-each-ref refs/heads --format '%(refname:short)' |
  ~/usr/local/bin/forget-backups |
  xargs -r -t -n 1 git --git-dir ~/.bup branch -q -D

bup fsck -g
