#!/bin/bash
set -e
set -x

lock=
while getopts "l" opt; do
  case $opt in
    l) lock='-l';;
    *) exit 1;;
  esac
done
shift $((OPTIND - 1))

if [ -z "$lock" ]; then
  flock -x ~/etc/backup.cfg "$0" -l
  exit
fi

source ~/etc/backup.cfg

mountpoint=/media/s3ql
basedir="$mountpoint"/$(hostname)
work="$basedir"/work
dir="$basedir"/"$now"

~/bin/mount-s3ql

mkdir -p "$work"
rsync -avhq --xattrs --hard-links --delete --delete-excluded $basic_excludes --whole-file --inplace --one-file-system ~/ "$work"

sudo s3qlcp "$work" "$dir".s3qlcp
mv "$dir".s3qlcp "$dir".s3qllock

sudo s3qllock "$dir".s3qllock
mv "$dir".s3qllock "$dir"

sudo s3qlctrl upload-meta "$mountpoint"
