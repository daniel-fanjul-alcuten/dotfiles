#!/bin/bash
set -e
set -x

lock=
while getopts "l" opt; do
  case $opt in
    l) lock='-l';;
    *) exit 1;;
  esac
done
shift $((OPTIND - 1))

if [ -z "$lock" ]; then
  flock -x ~/etc/backup.cfg "$0" -l
  exit
fi

source ~/etc/backup.cfg

for name in s3ql dfs3ql; do

  mountpoint="/media/$name"
  if ! sudo mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -p "$dir"
  chmod g+w "$dir" || true

  dir="$mountpoint"/backups
  mkdir -p "$dir"
  chmod g+w "$dir" || true

  dir="$dir"/$(hostname)
  mkdir -p "$dir"
  chmod g+w "$dir" || true

  dir="$dir"/$(whoami)
  mkdir -p "$dir"
  chmod g+w "$dir" || true

  work="$dir"/work
  mkdir -p "$work"
  ~/bin/rsync-s3ql -v --delete --delete-excluded $basic_excludes --one-file-system ~/ "$work"

  dir="$dir"/"$now"
  sudo s3qlcp "$work" "$dir".s3qlcp
  mv "$dir".s3qlcp "$dir".s3qllock
  sudo s3qllock "$dir".s3qllock
  mv "$dir".s3qllock "$dir"

  sudo s3qlctrl upload-meta "$mountpoint"
done
