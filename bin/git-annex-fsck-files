#!/bin/bash
set -e
set -o pipefail

while getopts 'ucamwlf' opt; do
	case $opt in
		u) ulock=true;;
		c) clean=true;;
		a) annex=true;;
		m) mdrive=true;;
		w) wdrive=true;;
		l) ldrive=true;;
		f) flock=true;;
		*) exit 1
	esac
done
shift $((OPTIND - 1))

db=backups/fsck.qdbm
adb=~/var/annex/"$db"

if [ "$ulock" ]; then
	cd ~/var/annex && {
		git annex get "$db"
		git annex unlock "$db"
	}
fi

if [ "$clean" ]; then
	cd ~/var/annex && {
		list=`mktemp`
		dpmgr list -k "$db" > "$list"
		xargs -a "$list" -r -d \\n -I key \
			bash -c 'if [ '$((`date +%s` - 67 * 24 * 3600))' -gt `dpmgr get "'"$db"'" "key"` ]; then dpmgr out "'"$db"'" "key"; fi'
		rm -f "$list"
		date +%Y%m%d > ~/var/spool/anacron/cfsck
	}
fi

function run() {
	name="$1"
	dir="$2"
	cd "$dir" 2>/dev/null && {
		git annex find | while read file; do
			if afile=`readlink -e "$file"`; then
				key=`stat -c %Y "$afile"`:"$afile"
				time=`dpmgr get "$adb" "$key" 2>/dev/null` || time=0
				if [ $time -lt $((`date +%s` - $((61 * 24 * 3600)))) ]; then
					echo "$dir/$file"
					git annex fsck --quiet "$file" && dpmgr put "$adb" "$key" `date +%s`
				fi
			fi
		done
		date +%Y%m%d > ~/var/spool/anacron/"$name"
	}
}

if [ "$annex" ]; then
	run afsck ~/var/annex
fi

if [ "$mdrive" ]; then
	run mfsck /mdrive
fi

if [ "$wdrive" ]; then
	run wfsck /wdrive
fi

if [ "$ldrive" ]; then
	run lfsck /ldrive
fi

if [ "$flock" ]; then
	cd ~/var/annex && {
		dpmgr optimize "$db"
		git rm "$db"*.par2
		par2create -n1 -r5 "$db"
		git annex add "$db"*
		git commit -m "$db"
	}
fi

cd ~/var/annex && {
	dpmgr inform "$db"
}
