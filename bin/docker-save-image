#!/bin/bash
set -e

unset postponed
while getopts 'p' opt; do
  case $opt in
    p) postponed=true;;
    *) exit 1
  esac
done
shift $((OPTIND - 1))

id="$1" && shift || { echo id?; exit 1; }
name="$1" && shift || {
  name=$(sudo docker inspect -f '{{.RepoTags}}' "$id")
  name=$(sed 's,/,-,g' <<< "$name")
}

if [ -z "$postponed" ]; then
  mkdir -p ~/var/{lock,log}
  lock=docker-save-image-"$id-$name"
  nohup postpone -l ~/var/lock/lock-"$lock" "$0" -p "$id" "$name" &>> ~/var/log/"$lock".log &
  exit 0
fi
set -x

file=~/var/backups/docker/images/"$name-$id".tar
if ! [ -f "$file" ]; then
  mkdir -p "${file%/*}"
  sudo docker save -o "$file" "$id" || { rm -f "$file" && false; }
  sudo chown "$(whoami):$(whoami)" "$file"
fi
