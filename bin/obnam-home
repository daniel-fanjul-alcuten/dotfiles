#!/bin/bash
set -e
set -x

source ~/etc/backup.cfg

for name in "$@"; do

  mountpoint="/media/$name"
  if ! sudo mountpoint -q "$mountpoint"; then
    continue
  fi

  dir="$mountpoint"
  mkdir -m 0775 -p "$dir"

  dir="$mountpoint"/backups
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(hostname)
  mkdir -m 0775 -p "$dir"

  dir="$dir"/$(whoami)
  mkdir -m 0775 -p "$dir"

  repo="$dir"/obnam
  obnam --repository "$repo" backup --chunk-size=$((64*1024*1024)) $obnam_excludes --one-file-system ~
  obnam --repository "$repo" forget --keep 72h,7d,5w,12m

  sudo s3qlctrl upload-meta "$mountpoint"

done
