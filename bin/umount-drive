#!/bin/bash
set -e

umask 027

while getopts "n:sl" opt; do
  case $opt in
    n) name="$OPTARG";;
    s) s3ql=true;;
    l) luks=true;;
    *) exit 1;;
  esac
done
shift $((OPTIND - 1))

source ~/etc/colors.cfg

mount_point=/media/"$name"
if ! sudo mountpoint -q "$mount_point"; then
  green "$name: already umounted"
fi

umount=umount
if [ "$s3ql" ]; then
  umount=umount.s3ql
fi

if ! sudo umount "$mount_point"; then
  red "$name: umount failed"
fi

if ! sudo rm -f /"$name"; then
  red "$name: rm failed"
fi

if ! sudo rmdir "$mount_point"; then
  red "$name: rmdir failed"
fi

if [ "$luks" ]; then
  if ! sudo cryptsetup luksClose "$name"; then
    red "$name: luks close failed"
  fi
fi

blue "$name: umounted"
