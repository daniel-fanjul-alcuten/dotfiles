#!/bin/bash
set -x
set -e
set -o pipefail

unset s
unset e
unset m
while getopts 'sem:' opt; do
  case $opt in
    s)
      s=true;;
    e)
      e=true;;
    m)
      m="$OPTARG";;
    *)
      exit 1;;
  esac
done
shift $((OPTIND - 1))

origin="$1" && shift
target="$1" && shift

whoami=$(whoami)
hostname=$(hostname)

cmd="duplicity -vi --gpg-binary $(which gpg2) --ssh-options=\"-oBatchMode=yes -oControlPath=none\" --rsync-options=\"-e 'ssh -oBatchMode=yes -oControlPath=none'\" --exclude-other-filesystems --asynchronous-upload"
if [ "$s" ]; then
  cmd="sudo SSH_AUTH_SOCK=\"$SSH_AUTH_SOCK\" GPG_AGENT_INFO=\"~/.gnupg/S.gpg-agent\" $cmd"
fi
if [ "$e" ]; then
  cmd="$cmd --use-agent --encrypt-key \"<$whoami@$hostname>\" --sign-key \"<$whoami@$hostname>\""
else
  cmd="$cmd --no-encryption"
fi

if [ "$m" ]; then
  mountpoint -q "$m"
fi
eval nice ionice -c 3 "$cmd" "$@" \""$origin"\" \""$target"\"

if [ "$m" ]; then
  mountpoint -q "$m"
fi
eval nice ionice -c 3 "$cmd" cleanup --force "$target"

if [ "$m" ]; then
  mountpoint -q "$m"
fi
eval nice ionice -c 3 "$cmd" remove-older-than 13W "$target"
